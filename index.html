<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT CPNS PRO - DIMAS MIFTAH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0f4f8; -webkit-user-select: none; user-select: none; }
        .timer-low { color: #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loader { border-top-color: #4f46e5; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #progress-bar { transition: width 1s linear; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="loading-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="loader w-12 h-12 border-4 border-slate-200 rounded-full mb-4"></div>
        <p class="text-indigo-600 font-bold animate-pulse text-[10px] tracking-widest uppercase">Sinkronisasi Data...</p>
    </div>

    <div class="sticky top-0 z-40 bg-indigo-800 text-white shadow-lg">
        <div class="max-w-md mx-auto p-4 flex justify-between items-center px-4">
            <button onclick="location.reload()" class="hover:bg-white/20 p-2 rounded-xl transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
            <div class="text-center">
                <p id="timer" class="text-xl font-black leading-none mb-1">100:00</p>
                <div id="live-badge" class="hidden flex items-center justify-center gap-1">
                    <span id="kat-aktif" class="text-[8px] font-black uppercase tracking-widest text-yellow-400">READY</span>
                </div>
            </div>
            <div class="flex items-center gap-2 border-l border-white/20 pl-3 text-center">
                <div class="bg-white/10 px-3 py-1 rounded-lg">
                    <p class="text-[7px] font-bold text-yellow-400 uppercase mb-0.5">Skor</p>
                    <p id="skor" class="text-xs font-black">0</p>
                </div>
            </div>
        </div>
        <div class="w-full h-1 bg-indigo-900"><div id="progress-bar" class="h-full bg-yellow-400 w-full shadow-[0_0_10px_#facc15]"></div></div>
    </div>

    <main class="max-w-md mx-auto w-full p-4 flex-grow mb-28">
        <div id="setup-area" class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 space-y-6">
            <div class="text-center space-y-2">
                <h1 class="text-2xl font-black text-indigo-900 leading-tight">CAT SIMULASI CPNS</h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Developed by Dimas Miftah</p>
                <a href="https://trakteer.id/dimasmiftah_" target="_blank" class="inline-block mt-2 text-[9px] font-black text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full hover:bg-indigo-100 transition-colors uppercase tracking-widest">
                    ‚òï Traktir Kopi Developer
                </a>
            </div>
            <div class="space-y-4">
                <select id="sel-kat" onchange="cekKategori()" class="w-full p-4 rounded-2xl bg-slate-50 font-bold text-xs ring-1 ring-slate-100 outline-none">
                    <option value="TIU">SKD - TIU (Pass: 80)</option>
                    <option value="TWK">SKD - TWK (Pass: 65)</option>
                    <option value="SKB">SKB - KHUSUS JURUSAN</option>
                </select>
                <div id="box-jurusan" class="hidden">
                    <select id="sel-pend" class="w-full p-4 rounded-2xl bg-indigo-50 font-bold text-xs text-indigo-700 ring-1 ring-indigo-100 outline-none">
                        <option value="">-- Pilih Jurusan --</option>
                    </select>
                </div>
            </div>
            <button onclick="mulaiUjian()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-[1.5rem] shadow-lg active:scale-95 transition-all uppercase text-[10px] tracking-widest">Mulai Simulasi Sekarang</button>
        </div>

        <div id="quiz-area" class="hidden space-y-4">
            <div class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-slate-100 min-h-[300px] flex flex-col">
                <div class="mb-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Progress: <span id="counter-soal" class="text-indigo-600">0/0</span></div>
                <p id="tanya" class="text-slate-800 font-bold leading-relaxed mb-8 text-md"></p>
                <div id="opsi-list" class="space-y-3 mb-6"></div>
                
                <div id="bahas-box" class="hidden mt-auto p-6 bg-slate-900 rounded-[2rem] text-white">
                    <p id="kunci-text" class="font-black text-[10px] uppercase text-emerald-400 mb-2"></p>
                    <p id="bahas-text" class="text-slate-400 text-[11px] font-medium leading-relaxed mb-6 italic"></p>
                    <button onclick="ambilSoal()" class="w-full py-4 bg-white text-indigo-900 font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-lg">Lanjut Soal</button>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-hasil" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-indigo-950/80 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[3rem] overflow-hidden shadow-2xl">
            <div id="area-sertifikat" class="bg-white p-8 text-center relative">
                <div class="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none text-4xl font-black rotate-12 uppercase">DIMAS MIFTAH CPNS PRO</div>
                <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 relative z-10"><span class="text-4xl">üèÜ</span></div>
                <h2 class="text-2xl font-black text-indigo-900 mb-1 relative z-10">Hasil Simulasi</h2>
                <p id="hasil-status" class="text-[10px] font-black uppercase tracking-widest mb-4 text-slate-400 relative z-10">STATUS</p>
                
                <div class="grid grid-cols-2 gap-4 mb-8 relative z-10">
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Benar / Salah</p>
                        <p class="text-lg font-black text-emerald-500"><span id="hasil-benar">0</span> / <span id="hasil-salah" class="text-red-500">0</span></p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Total Skor</p>
                        <p id="hasil-skor" class="text-xl font-black text-indigo-600">0</p>
                        <p class="text-[6px] font-bold text-slate-400 uppercase">(Benar x 5 Poin)</p>
                    </div>
                </div>

                <div class="pt-4 border-t border-dashed border-slate-200">
                    <p class="text-[9px] font-bold text-slate-400 mb-1 uppercase tracking-widest">Simulasi by Dimas Miftah</p>
                    <div class="flex justify-center gap-4 text-[8px] font-black text-indigo-500">
                        <span>IG: @dimasmiftah_</span>
                        <span>TikTok: @dimasmiftah_</span>
                    </div>
                </div>
            </div>
            <div class="p-8 pt-0 space-y-3">
                <button onclick="downloadSertifikat()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl text-[10px] uppercase tracking-widest">Simpan Hasil (PNG)</button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="shareWA()" class="bg-emerald-50 text-emerald-600 font-black py-4 rounded-2xl text-[9px] uppercase">WA Share</button>
                    <button onclick="location.reload()" class="bg-slate-100 text-slate-600 font-black py-4 rounded-2xl text-[9px] uppercase">Ulangi</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 p-4 z-40">
        <div class="max-w-md mx-auto flex justify-between items-center px-4">
            <div>
                <p class="text-slate-400 text-[7px] font-black uppercase tracking-[0.2em]">Dimas Miftah ¬© 2026</p>
                <div class="flex gap-3 mt-1 text-indigo-600 items-center">
                    <a href="https://instagram.com/dimasmiftah_"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path></svg></a>
                    <a href="https://tiktok.com/@dimasmiftah_"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"></path></svg></a>
                    <span class="text-slate-300">|</span>
                    <a href="https://trakteer.id/dimasmiftah_" target="_blank" class="text-[8px] font-black uppercase tracking-tighter hover:underline">Support Project</a>
                </div>
            </div>
            <button onclick="finishUjian()" class="bg-red-50 text-red-600 text-[9px] font-black px-4 py-2 rounded-full uppercase">Selesai Ujian</button>
        </div>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyohFZLV5XmuMhuW13uYNY4zizjxjnPdYaGRpReVKXRpHXevE7P_ZfxyfBFZLVE9OxEPw/exec"; 
        let db = [], filteredSoal = [], skor = 0, benar = 0, salah = 0, waktu = 100 * 60, timerInterval, totalSoalKategori = 0, soalDikerjakan = 0;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f, d) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.frequency.value = f; g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        async function init() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                db = data.map(i => ({
                    kat: String(i.kategori || i.Kategori || "").trim(),
                    pend: String(i.jurusan || i.Jurusan || "").trim(),
                    soal: i.soal || i.Soal,
                    opsi: (i.opsi || i.Opsi) ? (i.opsi || i.Opsi).split(';') : [],
                    kunci: String(i.kunci || i.Kunci || "").trim(),
                    bahas: i.pembahasan || i.Pembahasan || ""
                }));
                const list = [...new Set(db.filter(x => x.kat.toUpperCase() === "SKB" && x.pend !== "").map(x => x.pend))].sort();
                const sel = document.getElementById('sel-pend');
                list.forEach(j => { sel.innerHTML += `<option value="${j}">${j}</option>`; });
                document.getElementById('loading-screen').classList.add('hidden');
            } catch (e) { alert("Koneksi Database Gagal!"); }
        }

        function cekKategori() {
            document.getElementById('box-jurusan').classList.toggle('hidden', document.getElementById('sel-kat').value !== "SKB");
        }

        function mulaiUjian() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const kat = document.getElementById('sel-kat').value;
            const pend = document.getElementById('sel-pend').value;
            filteredSoal = db.filter(x => x.kat === kat);
            if(kat === "SKB") filteredSoal = filteredSoal.filter(x => x.pend === pend);
            if(filteredSoal.length === 0) return alert("Soal tidak ditemukan!");
            totalSoalKategori = filteredSoal.length;
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('quiz-area').classList.remove('hidden');
            document.getElementById('live-badge').classList.remove('hidden');
            document.getElementById('kat-aktif').innerText = kat;
            startTimer(); ambilSoal();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                let m = Math.floor(waktu / 60), s = waktu % 60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                document.getElementById('progress-bar').style.width = (waktu / (100*60) * 100) + "%";
                if (waktu <= 0) finishUjian();
                waktu--;
            }, 1000);
        }

        function ambilSoal() {
            if (filteredSoal.length === 0) return finishUjian();
            const idx = Math.floor(Math.random() * filteredSoal.length);
            const item = filteredSoal[idx];
            filteredSoal.splice(idx, 1);
            
            document.getElementById('bahas-box').classList.add('hidden');
            document.getElementById('tanya').innerText = item.soal;
            const box = document.getElementById('opsi-list'); box.innerHTML = "";
            
            item.opsi.forEach(o => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-4 rounded-2xl border-2 border-slate-100 bg-slate-50 font-bold text-xs text-slate-600 transition active:scale-95";
                b.innerText = o.trim();
                b.onclick = () => {
                    soalDikerjakan++;
                    document.getElementById('counter-soal').innerText = `${soalDikerjakan}/${totalSoalKategori}`;
                    document.querySelectorAll('#opsi-list button').forEach(btn => btn.disabled = true);
                    
                    if(o.trim() === item.kunci.trim()) {
                        b.classList.add('bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
                        skor += 5; benar++; playBeep(880, 0.1);
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.8 } });
                    } else {
                        b.classList.add('bg-red-50', 'border-red-500', 'text-red-700');
                        salah++; if(navigator.vibrate) navigator.vibrate(200); playBeep(220, 0.2);
                        document.querySelectorAll('#opsi-list button').forEach(btn => {
                            if(btn.innerText.trim() === item.kunci.trim()) btn.classList.add('text-emerald-600', 'font-black');
                        });
                    }
                    document.getElementById('skor').innerText = skor;
                    document.getElementById('kunci-text').innerText = "Kunci Jawaban: " + item.kunci;
                    document.getElementById('bahas-text').innerText = item.bahas;
                    document.getElementById('bahas-box').classList.remove('hidden');
                };
                box.appendChild(b);
            });
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function finishUjian() {
            clearInterval(timerInterval);
            document.getElementById('modal-hasil').classList.remove('hidden');
            document.getElementById('hasil-benar').innerText = benar;
            document.getElementById('hasil-salah').innerText = salah;
            document.getElementById('hasil-skor').innerText = skor;
            const kat = document.getElementById('sel-kat').value;
            let pg = kat === "TIU" ? 80 : (kat === "TWK" ? 65 : 0);
            const st = document.getElementById('hasil-status');
            st.innerText = skor >= pg ? "LULUS PASSING GRADE" : "BELUM LULUS PG";
            st.className = `text-[10px] font-black uppercase tracking-widest mb-4 ${skor >= pg ? 'text-emerald-500' : 'text-red-500'}`;
        }

        function downloadSertifikat() {
            html2canvas(document.getElementById('area-sertifikat'), { scale: 3 }).then(c => {
                const a = document.createElement('a'); a.download = 'Skor_CAT_DimasMiftah.png';
                a.href = c.toDataURL(); a.click();
            });
        }

       function shareWA() {
            const status = document.getElementById('hasil-status').innerText;
            const linkWeb = window.location.href;
            const text = `üèÜ *HASIL SIMULASI CAT CPNS* üèÜ\n--------------------------------------------\nüéØ *Total Skor:* ${skor}\n‚úÖ *Benar:* ${benar}\n‚ùå *Salah:* ${salah}\nüì¢ *Status:* ${status}\n\nüöÄ *Coba Simulasi Gratis di:*\n${linkWeb}\n\n--------------------------------------------\nüì± *Developed by Dimas Miftah*\nüì∏ *Instagram:* https://instagram.com/dimasmiftah_\nüé• *TikTok:* https://tiktok.com/@dimasmiftah_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        init();
    </script>
</body>
</html>
